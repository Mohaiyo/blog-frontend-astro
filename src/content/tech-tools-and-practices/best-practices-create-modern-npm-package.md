---
title: 'åˆ›å»ºä¸€ä¸ªç°ä»£npmåŒ…çš„æœ€ä½³å®è·µ'
pubDate: 2024-01-21
description: 'æŠ€æœ¯æ€»æ˜¯åœ¨å˜åŒ–ï¼Œä½ çš„æµç¨‹å’Œå®è·µéœ€è¦è·Ÿä¸Šè¿™äº›å˜åŒ–ã€‚å› æ­¤ï¼Œè™½ç„¶npmå·²æœ‰ 13 å¹´å†å²ï¼Œä½†ä½ å›´ç»•npmåŒ…åˆ›å»ºçš„å®è·µåº”è¯¥ä¼šæ›´åŠ ç°ä»£ã€‚ä¸è¿‡ï¼Œå¦‚æœä½ æ„Ÿè§‰å®ƒä»¬å¯èƒ½æœ‰ç‚¹è¿‡æ—¶äº†ï¼Œè¯·ç»§ç»­é˜…è¯»ã€‚'
author: 'Wayne.Liang'
image:
  cover: '../assets/tech-tools-and-practices/best-practices-create-modern-npm-package.png'
  alt: 'Best practices for creating a modern npm package with security in mind'
category: 'æŠ€æœ¯å·¥å…·ä¸å®è·µ'
tags: ['NPM', 'GITHUB']
---

> åŸæ–‡åœ°å€ [Best practices for creating a modern npm package with security in mind](https://snyk.io/blog/best-practices-create-modern-npm-package/)

> åŸæ–‡ä½œè€… [Brian clark](https://snyk.io/contributors/brian-clark/)

## Contents

## ç®€ä»‹

åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†é€æ­¥ä½¿ç”¨ç°ä»£æœ€ä½³å®è·µï¼ˆæˆªè‡³ 2023 å¹´ï¼‰åˆ›å»º npm åŒ…ã€‚ ä½ å°†é¦–å…ˆå­¦ä¹ å¦‚ä½•åˆ›å»º npm åŒ…ï¼Œä»¥ä¾¿ç†Ÿæ‚‰æ„å»ºåŒ…å¹¶å°†å…¶å‘å¸ƒåˆ° npm æ³¨å†Œè¡¨ã€‚ ç„¶åï¼Œä½ å°†äº†è§£å¦‚ä½•é€šè¿‡è®¾ç½®æµ‹è¯•æ¡†æ¶ã€æŒç»­é›†æˆå’Œéƒ¨ç½²ç®¡é“ã€å®‰å…¨æ£€æŸ¥ä»¥åŠç”¨äºå‘å¸ƒçš„è‡ªåŠ¨åŒ–è¯­ä¹‰ç‰ˆæœ¬ç®¡ç†æ¥åˆ¶ä½œæ›´å¼ºå¤§ä¸”å¯ç”¨äºç”Ÿäº§çš„ npm åŒ…ã€‚ åœ¨æœ¬æ•™ç¨‹ç»“æŸæ—¶ï¼Œä½ å°†å¯¹è‡ªå·±ç”Ÿæˆç°ä»£ä¸”å¯æŒç»­çš„ npm åŒ…çš„èƒ½åŠ›å……æ»¡ä¿¡å¿ƒã€‚ è®©æˆ‘ä»¬å¼€å§‹å§ï¼

## å…ˆå†³æ¡ä»¶

1. ç†Ÿæ‚‰Node.js,Javascript,GitHub,å’ŒGitHub Actions
2. å¯ä»¥ç”¨äºååŠ©åˆ›å»ºnpmåŒ…çš„å¼€å‘å·¥å…·

## ç®€å•ç¤ºä¾‹NPMåŒ…

æˆ‘ä»¬é¦–å…ˆé€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥äº†è§£ä¸€ä¸‹åˆ›å»ºå’Œå‘å¸ƒ npm åŒ…çš„è¿‡ç¨‹ã€‚å¦‚æœä½ å·²ç»ç†Ÿæ‚‰è¿™ä¸€ç‚¹ï¼Œä½ å¯ä»¥è·³åˆ°[ç”Ÿäº§å°±ç»ªçš„npmåŒ…](#ç”Ÿäº§å°±ç»ªçš„npmåŒ…)éƒ¨åˆ†ï¼Œå…¶ä¸­æ¶µç›–äº†æ›´é«˜çº§çš„ä¸»é¢˜ã€‚

### è®¾ç½®ä½ è‡ªå·±çš„é¡¹ç›®

ä½ éœ€è¦åœ¨ GitHub ä¸­åˆ›å»ºä¸€ä¸ªé¡¹ç›®æ‰èƒ½å¼€å§‹ï¼Œå› æ­¤è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤å¯åŠ¨é¡¹ç›®ã€‚å¦‚æœä½ å·²ç»æœ‰ä¸€ä¸ªç°æˆçš„å¯ä¾›ä½¿ç”¨ï¼Œä½ å¯ä»¥è·³åˆ°ä¸‹ä¸€ç« èŠ‚ï¼Œä½†è¯·**åŠ¡å¿…ä»”ç»†æ£€æŸ¥æœ¬å°èŠ‚çš„æ­¥éª¤ 5**ä¸­æœ‰å…³åŒ…åç§°ã€‚

1. åˆ›å»º GitHub å­˜å‚¨åº“ï¼š[https://github.com/new](https://github.com/new)

2. å…‹éš†æä¾›çš„ç¤ºä¾‹ä»“åº“åˆ°æœ¬åœ°,åœ°å€å¦‚ä¸‹ã€‚

```bash
git clone https://github.com/snyk-snippets/simple-npm-package.git
```

3. æ‰“å¼€ç»ˆç«¯å¹¶å°†ç›®å½•æ›´æ”¹ä¸ºå…‹éš†é¡¹ç›®çš„æ–‡ä»¶å¤¹ã€‚

```bash
cd simple-npm-package
```

4. è¿è¡Œ `npm init -y` åˆ›å»º `package.json` æ–‡ä»¶ã€‚æ³¨æ„ï¼šå¦‚æœä½ å…‹éš†äº†ç¤ºä¾‹å­˜å‚¨åº“ï¼Œåˆ™æ— éœ€æ‰§è¡Œæ­¤æ­¥éª¤ã€‚

5. ä½¿ç”¨èŒƒå›´åç§°æ›´æ–° `package.json` ä¸­çš„ `name` å±æ€§ã€‚ç¤ºä¾‹ï¼š`@[username]/simple-npm-package`ã€‚è¯·åŠ¡å¿…ä½¿ç”¨ä½ çš„ç”¨æˆ·åæˆ–ç»„ç»‡åç§°ï¼Œè€Œä¸æ˜¯ **@snyk-snippets**ã€‚

åˆ›å»ºé¡¹ç›®åï¼Œä½ å¯ä»¥ç»§ç»­åˆ›å»º npm å¸æˆ·ã€‚é€šè¿‡æœ¬æ•™ç¨‹çš„å…¶ä½™éƒ¨åˆ†ï¼Œä½ å°†çœ‹åˆ°æˆ‘æ­£åœ¨å¤„ç†å­˜å‚¨åº“çš„æœ¬åœ°å…‹éš†`clarkio/simple-npm-package`ã€‚

### è®¾ç½®ä½ çš„npmè´¦å·

ä¸ºäº†èƒ½å¤Ÿè®©ä½ çš„ npm åŒ…å¯ä¾›å…¶ä»–äººä½¿ç”¨ï¼Œä½ éœ€è¦ä¸€ä¸ª npm å¸æˆ·ã€‚ä»¥ä¸‹æ­¥éª¤å°†å¼•å¯¼ä½ åˆ›å»ºè‡ªå·±çš„å¸æˆ·ï¼ˆå¦‚æœä½ è¿˜æ²¡æœ‰å¸æˆ·ï¼‰ï¼Œå¯ç”¨åŒå› ç´ èº«ä»½éªŒè¯ (2FA) ä»¥æé«˜å¸æˆ·çš„å®‰å…¨æ€§ï¼Œå¹¶å°†ä½ çš„å¸æˆ·è¿æ¥åˆ°æœ¬åœ°è®¡ç®—æœºã€‚

1. åœ¨ [https://www.npmjs.com/signup](https://www.npmjs.com/signup) ä¸Šæ³¨å†Œ npmã€‚
2. ä¸ºäº†è·å¾—æ›´å¥½çš„å®‰å…¨æ€§ï¼Œè¯·åœ¨ä½ çš„ npm å¸æˆ·ä¸Šå¯ç”¨ 2FAï¼šhttps://docs.npmjs.com/configuring-two-factor-authentication
3. ä½¿ç”¨å‘½ä»¤ `npm login` åœ¨ç»ˆç«¯ä¸­ä½¿ç”¨ä½ çš„ npm å¸æˆ·ç™»å½•ï¼Œç„¶åæŒ‰ç…§å±å¹•ä¸Šçš„è¯´æ˜è¿›è¡Œæ“ä½œï¼š

```bash
> npm login
npm notice Log in on https://registry.npmjs.org/
Username: clarkio
Password:
Email: (this IS public) <email address>
npm notice Please use the one-time password (OTP) from your authenticator application
Enter one-time password from our authenticator app: <OTP>
Logged in as clarkio on https://registry.npmjs.org/.
```

ä¸€æ—¦ä½ æ‹¥æœ‰ä¸€ä¸ª npm é¡¹ç›®å’Œä¸€ä¸ª npm å¸æˆ·ï¼Œä½ å°±å¯ä»¥å°†ä½ çš„ npm åŒ…å‘å¸ƒåˆ°[å…¬å…±å’Œå®˜æ–¹ npmjs æ³¨å†Œè¡¨](https://npmjs.org/).ä½¿å…¶å¯ä¾›å…¶ä»–äººä½¿ç”¨ã€‚åœ¨æ‰§è¡Œä¹‹å‰ï¼Œä½ å¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ£€æŸ¥å°†è¦å‘å¸ƒçš„å†…å®¹ï¼Œç„¶åè¿è¡Œå®é™…çš„å‘å¸ƒè¿‡ç¨‹ï¼š

1. åœ¨ç»ˆç«¯ä¸­ï¼Œè¿è¡Œ `npx npm-packlist` ä»¥æŸ¥çœ‹å°†åŒ…å«åœ¨åŒ…çš„å‘å¸ƒç‰ˆæœ¬ä¸­çš„å†…å®¹ã€‚

è¿™å¯ç¡®ä¿ä½ ä¸ä¼šä¸¢å¤±åŒ…æ­£å¸¸è¿è¡Œæ‰€éœ€çš„ä»»ä½•æºä»£ç æ–‡ä»¶ã€‚ç¡®ä¿ä½ ä¸ä¼šæ„å¤–å‘å…¬ä¼—æ³„éœ²æ•æ„Ÿä¿¡æ¯ï¼ˆä¾‹å¦‚å¸¦æœ‰æ•°æ®åº“å‡­æ®æˆ– API å¯†é’¥çš„æœ¬åœ°é…ç½®æ–‡ä»¶ï¼‰ä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„åšæ³•ã€‚

```bash
> npx npm-packlist
LICENSE
index.js
package.json
README.md
```

2. åœ¨ç»ˆç«¯ä¸­ï¼Œè¿è¡Œ `npm publish --dry-run` ä»¥æŸ¥çœ‹å®é™…è¿è¡Œè¯¥å‘½ä»¤æ—¶ä¼šæ‰§è¡Œä»€ä¹ˆæ“ä½œã€‚
3. åœ¨ç»ˆç«¯ä¸­ï¼Œè¿è¡Œ `npm publish --access=public` ä»¥å°†åŒ…å®é™…å‘å¸ƒåˆ° npmã€‚æ³¨æ„ï¼šä½œç”¨åŸŸåŒ…ï¼ˆ@clarkio/simple-npm-packageï¼‰éœ€è¦ `--access=public`ï¼Œå› ä¸ºå®ƒä»¬é»˜è®¤æ˜¯ç§æœ‰çš„ã€‚å¦‚æœå®ƒæ²¡æœ‰ä½œç”¨åŸŸå¹¶ä¸”åœ¨ `package.json` ä¸­æ²¡æœ‰å°†ç§æœ‰å­—æ®µè®¾ç½®ä¸º `true`ï¼Œé‚£ä¹ˆå®ƒä¹Ÿå°†æ˜¯å…¬å…±çš„ã€‚

```bash
> npm publish --access=public
npm notice
npm notice ğŸ“¦@clarkio/simple-npm-package@0.0.1
npm notice === Tarball Contents ===
npm notice 1.1kB LICENSE
npm notice 1.2kB README.md
npm notice 95B index.js
npm notice 690B package.json
npm notice === Tarball Details===
npm notice name: @clarkio/simple-npm-package
npm notice version: 0.0.1
npm notice filename:@clarkio/simple-npm-package-0.0.1.tgz
npm notice package size:2.1 kB
npm notice unpacked size: 4.1 kB
npm notice shasum:6f335d6254ebb77a5a24ee729650052a69994594
npm notice integrity:sha512-VZ1K1eMFOKeJW[...]7ZjKFVAxLcpdQ==
npm notice total files:4
npm notice
This operation requires a one-time password.
Enter OTP: <OTP>
+ @clarkio/simple-npm-package@0.0.1
```

ä½ å®Œæˆäº†ï¼ä½ å·²ç»å®Œæˆäº†è‡ªå·±çš„ npm åŒ…çš„æ„å»ºå’Œéƒ¨ç½²ã€‚æ¥ä¸‹æ¥ï¼Œä½ å°†å­¦ä¹ å¦‚ä½•åˆ¶ä½œä¸€ä¸ªæ›´å¼ºå¤§çš„åŒ…ï¼Œä¸ºç”Ÿäº§ç¯å¢ƒåšå¥½å‡†å¤‡å¹¶å¾—åˆ°æ›´å¹¿æ³›çš„ä½¿ç”¨ã€‚

## ç”Ÿäº§å°±ç»ªçš„npmåŒ…

è™½ç„¶å‰é¢çš„ç¤ºä¾‹åŒ…å¯èƒ½ä¼šåœ¨ç”Ÿäº§ä¸­ä½¿ç”¨ï¼Œéšç€æ—¶é—´çš„æ¨ç§»ï¼Œå®ƒéœ€è¦æ‰‹åŠ¨æ¥è·Ÿä¸Šå…¶ç»´æŠ¤ã€‚ä½¿ç”¨å·¥å…·å’Œè‡ªåŠ¨åŒ–ä»¥åŠé€‚å½“çš„æµ‹è¯•å’Œå®‰å…¨æ£€æŸ¥å°†æœ‰åŠ©äºæœ€å¤§é™åº¦åœ°å‡å°‘ä¿æŒåŒ…é¡ºåˆ©è¿è¡Œçš„æ€»ä½“å·¥ä½œé‡ã€‚è®©æˆ‘ä»¬æ›´æ·±å…¥åœ°äº†è§£å…¶ä¸­æ¶‰åŠä»€ä¹ˆã€‚

ä»¥ä¸‹ç« èŠ‚å°†æ¶µç›–ï¼š

1. è®¾ç½®ä½ çš„ `modern-npm-package`é¡¹ç›®
2. æ„å»º CommonJS (CJS) å’Œ ECMAScript (ESM) æ¨¡å—æ ¼å¼
3. è®¾ç½®å’Œç¼–å†™å•å…ƒæµ‹è¯•
4. å®æ–½å®‰å…¨æ£€æŸ¥
5. è‡ªåŠ¨åŒ–ç‰ˆæœ¬ç®¡ç†å’Œå‘å¸ƒ

å¦‚æœä½ åœ¨é˜…è¯»æœ¬æ–‡æ—¶æ²¡æœ‰è‡ªå·±çš„é¡¹ç›®å¯ä»¥ä½¿ç”¨ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ç¤ºä¾‹é¡¹ç›®ä½œä¸ºå‚è€ƒï¼šhttps://github.com/snyk-snippets/modern-npm-package

### è®¾ç½®ä½ çš„é¡¹ç›®

ä½ éœ€è¦åœ¨ GitHub ä¸­åˆ›å»ºä¸€ä¸ªé¡¹ç›®æ‰èƒ½å¼€å§‹ï¼Œå› æ­¤è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤å¯åŠ¨é¡¹ç›®ã€‚å¦‚æœä½ å·²ç»æœ‰ä¸€ä¸ªç°æˆé¡¹ç›®å¯ä¾›ä½¿ç”¨ï¼Œä½ å¯ä»¥è·³åˆ°ä¸‹ä¸€ç« èŠ‚ï¼Œä½†è¯·**åŠ¡å¿…ä»”ç»†æ£€æŸ¥æœ¬å°èŠ‚çš„æ­¥éª¤ 5**ä¸­æœ‰å…³åŒ…åç§°ã€‚

1. åˆ›å»º æ–°çš„GitHub å­˜å‚¨åº“ï¼š[https://github.com/new](https://github.com/new)

2. å…‹éš†æä¾›çš„ç¤ºä¾‹ä»“åº“åˆ°æœ¬åœ°,åœ°å€å¦‚ä¸‹ã€‚

```bash
git clone git@github.com:snyk-snippets/modern-npm-package.git
```

3. æ‰“å¼€ç»ˆç«¯å¹¶å°†ç›®å½•æ›´æ”¹ä¸ºå…‹éš†é¡¹ç›®çš„æ–‡ä»¶å¤¹ã€‚

```bash
cd modern-npm-package
```

4. è¿è¡Œ `npm init -y` åˆ›å»º `package.json` æ–‡ä»¶ã€‚æ³¨æ„ï¼šå¦‚æœä½ å…‹éš†äº†ç¤ºä¾‹å­˜å‚¨åº“ï¼Œåˆ™æ— éœ€æ‰§è¡Œæ­¤æ­¥éª¤ã€‚

5. ä½¿ç”¨èŒƒå›´åç§°æ›´æ–° `package.json` ä¸­çš„ `name` å±æ€§ã€‚ç¤ºä¾‹ï¼š`@[username]/modern-npm-package`ã€‚è¯·åŠ¡å¿…ä½¿ç”¨ä½ çš„ç”¨æˆ·åæˆ–ç»„ç»‡åç§°ï¼Œè€Œä¸æ˜¯ **@snyk-snippets**ã€‚

6. ä¸ºåŒ…ç¼–å†™ä»£ç ï¼ˆæˆ–è€…ä»…ä½¿ç”¨ index.ts ä¸­çš„ hello world ç¤ºä¾‹ï¼‰ã€‚

åˆ›å»ºé¡¹ç›®åï¼Œä½ å¯ä»¥ç»§ç»­åˆ›å»º npm å¸æˆ·ã€‚é€šè¿‡æœ¬æ•™ç¨‹çš„å…¶ä½™éƒ¨åˆ†ï¼Œä½ å°†çœ‹åˆ°æˆ‘æ­£åœ¨å¤„ç†å­˜å‚¨åº“çš„æœ¬åœ°å…‹éš†`clarkio/modern-npm-package`ã€‚

### æ„å»ºCommonJSå’ŒECMAScriptæ¨¡å—åŒ–æ ¼å¼çš„npmåŒ…

è™½ç„¶ ECMAScript æ¨¡å—æ ¼å¼ç°åœ¨åœ¨ Node.js 12+ ç‰ˆæœ¬ä¸­å¾—åˆ°åŸç”Ÿæ”¯æŒï¼Œä½†å®ƒå°šæœªè¢«ç¤¾åŒºå¹¿æ³›é‡‡ç”¨ã€‚ä¸ºäº†é¢å‘æœªæ¥å¹¶æ”¯æŒè¿™ä¸¤ç§æ ¼å¼ï¼Œä½ å°†çœ‹åˆ°å¦‚ä½•ä½¿ç”¨ TypeScript ä¸ºå®ƒä»¬å‡†å¤‡ npm åŒ…ã€‚

1. é¦–å…ˆåˆ›å»ºä¸€ä¸ªåŸºç¡€åä¸º`tsconfig.base.json`çš„é…ç½®æ–‡ä»¶ã€‚è¿™æ˜¯é€šç”¨çš„ç¼–è¯‘è®¾ç½®ï¼Œæ— è®ºä½ çš„ç›®æ ‡æ˜¯å“ªç§æ¨¡å—æ ¼å¼ï¼Œéƒ½å¯ä»¥ä½¿ç”¨è¿™äº›è®¾ç½®ã€‚è¯·æ ¹æ®ä½ çš„é¡¹ç›®éœ€è¦éšæ„è°ƒæ•´è¿™äº›ï¼Œç‰¹åˆ«æ˜¯å¦‚æœä½ ä¸ä½¿ç”¨æä¾›çš„ç¤ºä¾‹ï¼Œä½ å°†éœ€è¦è°ƒæ•´æ–‡ä»¶å±æ€§ä»¥ä¸ä½ çš„é¡¹ç›®ç»“æ„ä¿æŒä¸€è‡´ã€‚

```json
{
  "compilerOptions": {
    "strict": true,
    "esModuleInterop": true,
    "forceConsistentCasingInFileNames": true,
    "skipLibCheck": true,
    "checkJs": true,
    "allowJs": true,
    "declaration": true,
    "declarationMap": true,
    "allowSyntheticDefaultImports": true
  },
  "files": ["../src/index.ts"]
}
```

2. ç„¶ååˆ›å»ºä¸€ä¸ª CommonJS æ ¼å¼çš„ TypeScript é…ç½®æ–‡ä»¶ï¼Œå¹¶å°†å…¶å‘½åä¸º `tsconfig.cjs.json`ã€‚

- `lib` å±æ€§å‘ TypeScript æŒ‡ç¤ºå®ƒåº”è¯¥å¼•ç”¨å“ªäº›ç±»å‹æ¥å¸®åŠ©ä½ ä¸ºé¡¹ç›®ç¼–å†™ä»£ç ã€‚
- `target` å±æ€§å‘ TypeScript æŒ‡ç¤ºè¦ç¼–è¯‘é¡¹ç›®ä»£ç çš„ JavaScript ç‰ˆæœ¬ã€‚
- `module` å±æ€§å‘ TypeScript æŒ‡ç¤ºç¼–è¯‘é¡¹ç›®ä»£ç æ—¶åº”ä½¿ç”¨å“ªç§ JavaScript æ¨¡å—æ ¼å¼ã€‚
- `moduleResolution` å±æ€§å¸®åŠ© TypeScript ç¡®å®šå¦‚ä½•å¼•ç”¨â€œimportâ€è¯­å¥
- `outDir` å’Œ `declarationDir` å±æ€§å‘ TypeScript æŒ‡ç¤ºå°†ç¼–è¯‘ä»£ç å’Œå®šä¹‰ä»£ç ä¸­ä½¿ç”¨çš„ç±»å‹çš„ç»“æœæ”¾ç½®åœ¨å“ªé‡Œã€‚

```json
{
  "extends": "./tsconfig.base.json",
  "compilerOptions": {
    "lib": ["ES6", "DOM"],
    "target": "ES6",
    "module": "CommonJS",
    "moduleResolution": "Node",
    "outDir": "../lib/cjs",
    "declarationDir": "../lib/cjs/types"
  }
}
```

3. ä¹‹åï¼Œåˆ›å»º ECMAScript æ ¼å¼çš„ TypeScript é…ç½®æ–‡ä»¶å¹¶å°†å…¶å‘½åä¸º `tsconfig.esm.json`ã€‚è¿™é‡Œçš„å±æ€§ä¸ä½ åœ¨ CommonJS é…ç½®ä¸­çœ‹åˆ°çš„ç›¸åŒï¼Œä½†ç°åœ¨å°†ç°ä»£ ECMAScript æ¨¡å—æ ¼å¼ä½œä¸ºå…¶è¾“å‡ºã€‚

```json
{
  "extends": "./tsconfig.base.json",
  "compilerOptions": {
    "lib": ["ES2022", "DOM"],
    "target": "ES2022",
    "module": "ESNext",
    "moduleResolution": "NodeNext",
    "outDir": "../lib/esm",
    "declarationDir": "../lib/esm/types"
  }
}
```

4. ä½¿ç”¨æŒ‡å‘ `lib` æ–‡ä»¶å¤¹çš„ `files` å­—æ®µæ›´æ–°ä½ çš„ `package.json` æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å« TypeScript ä¸ºä½ æ„å»ºåŒ…çš„ç»“æœã€‚

5. ä½¿ç”¨`exports`å­—æ®µæ›´æ–° `package.json` æ–‡ä»¶ï¼Œä»¥å®šä¹‰å¦‚ä½•æ ¹æ®ä½¿ç”¨çš„æ¨¡å—åŠ è½½å™¨ï¼ˆCJS ä¸ ESMï¼‰æŸ¥æ‰¾æºæ–‡ä»¶ã€‚ä½ å¯ä»¥åœ¨[Node.js æ–‡æ¡£](https://nodejs.org/api/packages.html#packages_exports)ä¸­é˜…è¯»æœ‰å…³æ­¤å¯¼å‡ºå­—æ®µæ”¯æŒçš„æ›´å¤šä¿¡æ¯ã€‚

```json
  "exports": {
    ".": {
      "import": {
        "types": "./lib/esm/types/index.d.ts",
        "default": "./lib/esm/index.mjs"
      },
      "require": {
        "types": "./lib/cjs/types/index.d.ts",
        "default": "./lib/cjs/index.js"
      }
    }
  },
```

6. æ›´æ–° `package.json` æ–‡ä»¶ `main` å’Œ `types` å­—æ®µä»¥æŒ‡å‘åŒ…çš„ CJS ç‰ˆæœ¬ã€‚è¿™æ˜¯ä½œä¸ºé»˜è®¤,åå¤‡é€‰é¡¹ã€‚

```json

"types": "./lib/cjs/types/index.d.ts",
"main": "./lib/cjs/index.js"

```

7. å°† `files` å­—æ®µæ·»åŠ åˆ° `package.json` æ–‡ä»¶ä¸­ï¼Œä»¥æŒ‡ç¤º npm æ‰“åŒ…ä»£ç è¿›è¡Œå‘å¸ƒæ—¶åº”åŒ…å«å“ªäº›æ–‡ä»¶ã€‚

```json
"files": [
   "lib/**/*"
],
```

8. é€šè¿‡ `package.jso`n ä¸­çš„ `script` å­—æ®µåˆ›å»ºå‘½ä»¤ä»¥ä½¿ç”¨ `tsc` å¹¶ç¼–è¯‘åŒ…çš„ CJS å’Œ ESM æ ¼å¼ã€‚è¿™å°†å¯¼è‡´ç”Ÿæˆ `lib` æ–‡ä»¶å¤¹çš„æºæ–‡ä»¶ã€‚

- `clean` è„šæœ¬ç”¨äºåˆ é™¤è¿‡å»æ„å»ºçš„è¾“å‡ºå¹¶ä»å¤´å¼€å§‹ã€‚
- `build:esm` è„šæœ¬æœ«å°¾çš„ `mv lib/esm/index.js` `lib/esm/index.mjs` é‡å‘½åæ–‡ä»¶æ‰©å±•åï¼Œä»¥ä¾¿ Node.js æ¨¡å—åŠ è½½å™¨çŸ¥é“å®ƒæ˜¯ ESM æ¨¡å—ã€‚
- npm åœ¨æ‰“åŒ… npm åŒ…ä»¥å‡†å¤‡å‘å¸ƒåˆ°æ³¨å†Œè¡¨ä¹‹å‰ä½¿ç”¨ `prepack` è„šæœ¬

```json
 "clean": "rm -rf ./lib",
  "build": "npm run clean && npm run build:esm && npm run build:cjs",
  "build:esm": "tsc -p ./configs/tsconfig.esm.json && mv lib/esm/index.js lib/esm/index.mjs",
  "build:cjs": "tsc -p ./configs/tsconfig.cjs.json",
  "prepack": "npm run build"
```

9. ç°åœ¨ï¼Œä½ å¯ä»¥åœ¨ç»ˆç«¯ä¸­è¿è¡Œ `npm run build`ï¼Œè®© TypeScript æ„å»ºä½ çš„é¡¹ç›®ï¼Œä¸ºä½¿ç”¨å’Œå‘å¸ƒåšå¥½å‡†å¤‡ã€‚

è¿™å°±æ˜¯ä½¿ç”¨ TypeScript æ„å»ºæ”¯æŒ CommonJS å’Œ ECMAScript æ¨¡å—æ ¼å¼çš„ npm åŒ…æ‰€éœ€è¦åšçš„æ‰€æœ‰è®¾ç½®ã€‚æ¥ä¸‹æ¥ï¼Œä½ å°†å­¦ä¹ å¦‚ä½•é’ˆå¯¹ npm åŒ…ä»£ç è®¾ç½®å’Œè¿è¡Œæµ‹è¯•ï¼Œä»¥ç¡®ä¿å®ƒäº§ç”Ÿä½ æœŸæœ›çš„ç»“æœã€‚

### è®¾ç½®å’Œç¼–å†™å•å…ƒæµ‹è¯•

ä¸ºäº†å¯¹ä»£ç çš„è¡Œä¸ºå’Œç»“æœå……æ»¡ä¿¡å¿ƒï¼Œä½ éœ€è¦å®æ–½æµ‹è¯•è¿‡ç¨‹ã€‚æµ‹è¯•è¿«ä½¿ä½ åœ¨é¦–æ¬¡åˆ›å»ºä»£ç æ—¶ä»¥ä¸åŒçš„æ–¹å¼æ€è€ƒä»£ç çš„åŠŸèƒ½ï¼Œè€Œä¸æ˜¯å…¸å‹çš„ã€æ„‰å¿«çš„è·¯å¾„ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œä½ å¯ä»¥æƒ³åŠæ³•ç ´åä¸€ä¸ªå‡½æ•°ï¼Œä½¿å…¶æŠ›å‡ºé”™è¯¯æˆ–äº§ç”Ÿä¸æœŸæœ›çš„ç»“æœã€‚è¿™æ ·åšå°†ä½¿ä½ çš„åº”ç”¨ç¨‹åºæ›´å…·å¼¹æ€§å’Œå¯æŒç»­æ€§ï¼Œå¹¶ç¡®ä¿åœ¨æ·»åŠ æ›´å¤šåº”ç”¨ç¨‹åºæ—¶ä¸ä¼šå‡ºç°ä»»ä½•ä¸­æ–­ã€‚

å¦‚æœä½ æƒ³æ›´æ·±å…¥åœ°è¿›è¡Œæµ‹è¯•å¹¶äº†è§£å…¶æœ€ä½³å®è·µï¼Œè¯·åŠ¡å¿…é˜…è¯» Yoni Goldberg çš„ [JavaScript æœ€ä½³å®è·µå­˜å‚¨åº“](https://github.com/goldbergyoni/javascript-testing-best-practices)ã€‚

#### å•å…ƒæµ‹è¯•

ç¡®ä¿ä½ çš„åŒ…æŒ‰ç…§ä½ å¸Œæœ›çš„æ–¹å¼è¿è¡Œéœ€è¦é’ˆå¯¹ä½ çš„ä»£ç ç¼–å†™æµ‹è¯•ã€‚ä½ éœ€è¦ä¸€äº›å·¥å…·æ¥å¸®åŠ©è®¾ç½®é¡¹ç›®æ¥è¿è¡Œå•å…ƒæµ‹è¯•å¹¶æ˜¾ç¤ºç»“æœã€‚è¿™äº›å·¥å…·æ˜¯ Mocha.jsã€Chai.js å’Œ ts-nodeã€‚ [Mocha.js](https://mochajs.org/) æ˜¯ä¸€ä¸ªæµ‹è¯•è¿è¡Œç¨‹åºï¼Œ[Chai.js](https://www.chaijs.com/) æ˜¯ä¸€ä¸ªæ–­è¨€åº“ï¼Œå¯å¸®åŠ©ç¡®å®šä½ æ˜¯å¦ä»ä»£ç ä¸­è·å¾—äº†é¢„æœŸçš„ç»“æœï¼Œè€Œ [ts-node](https://www.npmjs.com/package/ts-node) å¸®åŠ©æˆ‘ä»¬åœ¨ TypeScript é¡¹ç›®ä¸­ä½¿ç”¨è¿™äº›å·¥å…·ã€‚è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤ä¸ºä½ çš„ npm åŒ…è®¾ç½®å¹¶è¿è¡Œæµ‹è¯•ï¼š

1. åœ¨ç»ˆç«¯ä¸­ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£…å¼€å‘äººå‘˜ä¾èµ–é¡¹ï¼š

```bash
npm i -D mocha @type/mocha chai @types/chai ts-node
```

2. åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ `.mocharc.json` ï¼Œå…¶ä¸­åŒ…å«ä»¥ä¸‹å†…å®¹ï¼š

```json
{
  "extension": ["ts"],
  "spec": "./**/*.spec.ts",
  "require": "ts-node/register"
}
```

3. åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªæµ‹è¯•æ–‡ä»¶å¤¹ã€‚

4. åœ¨æµ‹è¯•æ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªindex.spec.ts æ–‡ä»¶ã€‚

5. åœ¨`index.spec.ts`æ–‡ä»¶ä¸­ç¼–å†™å•å…ƒæµ‹è¯•æ¥æµ‹è¯•`index.ts`ä¸­çš„ä»£ç ã€‚ä½ å¯ä»¥å‚è€ƒç¤ºä¾‹ npm åŒ…å­˜å‚¨åº“ä½œä¸ºç¤ºä¾‹ï¼šhttps://github.com/snyk-snippets/modern-npm-package/blob/main/tests/index.spec.ts

6. åœ¨ `package.json` æ–‡ä»¶çš„è„šæœ¬éƒ¨åˆ†æ·»åŠ ä¸€ä¸ª`test`å±æ€§ï¼Œå¹¶ä¸ºå…¶æŒ‡å®šå€¼ `mocha`ã€‚

```json
  "scripts": {
    "clean": "rm -rf ./lib",
    "build": "npm run clean && npm run build:esm && npm run build:cjs",
    "build:esm": "tsc -p ./configs/tsconfig.esm.json && mv lib/esm/index.js lib/esm/index.mjs",
    "build:cjs": "tsc -p ./configs/tsconfig.cjs.json",
    "prepack": "npm run build",
    "test": "mocha"
  },
```

7. ä»é¡¹ç›®çš„æ ¹æ–‡ä»¶å¤¹åœ¨ç»ˆç«¯ä¸­è¿è¡Œ `npm test` ä»¥æ‰§è¡Œæµ‹è¯•å¹¶æŸ¥çœ‹ç»“æœï¼š

```bash
bc@mbp-snyk modern-npm-package % npm test

> @clarkio/modern-npm-package@0.0.0-development test
> mocha

  NPM Package
    âœ”ï¸ should be an object
    âœ”ï¸ should have a helloworld property

  Hello World Function
    âœ”ï¸  should be a function
    âœ”ï¸ should return the hello world message

4 passing (22ms)
```

#### åœ¨ç®¡é“ä¸­è¿›è¡Œæµ‹è¯•

ç°åœ¨ä½ å·²ç»æœ‰äº†æµ‹è¯•æ¥éªŒè¯ä»£ç çš„è¡Œä¸ºï¼Œä½ å¯ä»¥åœ¨ç®¡é“ä¸­ä½¿ç”¨å®ƒä»¬ã€‚è¿™å°†æœ‰åŠ©äºç¡®ä¿å­˜å‚¨åº“ä¸­å¼•å…¥çš„ä»»ä½•æ›´æ”¹éƒ½ä¸ä¼šç ´åä½ çš„ä»£ç è¡Œä¸ºã€‚æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤åˆ›å»ºæµ‹è¯•å·¥ä½œæµç¨‹ä½œä¸ºé¡¹ç›®ç®¡é“çš„ä¸€éƒ¨åˆ†ã€‚

1. ä¸ºä½ çš„å­˜å‚¨åº“åˆ›å»ºä¸€ä¸ªæ–°çš„ GitHub Actionï¼š`https://github.com/<your-account-or-organization>/<your-repo-name>/actions/new`
2. å°†å·¥ä½œæµç¨‹é‡å‘½åä¸º`tests.yml`
3. åœ¨å·¥ä½œæµç¨‹æ–‡ä»¶ä¸­æ’å…¥ä»¥ä¸‹ `Snyk Action` è„šæœ¬ï¼š

```yaml
name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [12.x, 14.x, 16.x, 18.x]

    steps:
      - uses: actions/checkout@v3
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
      - run: npm ci
      - run: npm test
```

æ­¤ YAML è„šæœ¬æ£€æŸ¥ä½ çš„æœ€æ–°ä»£ç ï¼Œå®‰è£…å…¶ä¾èµ–é¡¹ï¼Œå¹¶è¿è¡Œ `npm test` å‘½ä»¤æ¥æ‰§è¡Œä½ çš„æµ‹è¯•ã€‚å®ƒå¯¹`node-version`ç‰ˆæœ¬å­—æ®µä¸­åˆ—å‡ºçš„æ¯ä¸ª Node.js ç‰ˆæœ¬æ‰§è¡Œæ­¤æ“ä½œï¼Œä»¥ä¾¿ä½ å¯ä»¥ç¡®ä¿ä»£ç åœ¨æ¯ä¸ªè¿è¡Œæ—¶æŒ‰é¢„æœŸå·¥ä½œã€‚

ä½ ç°åœ¨å·²ç»å®Œæˆäº†é¡¹ç›®çš„è®¾ç½®ï¼Œä»¥ä¾¿æ ¹æ® npm åŒ…çš„ä»£ç è¿è¡Œå’Œè¯„ä¼°æµ‹è¯•ã€‚ä½†æ˜¯ï¼Œä½ å¯èƒ½ä¼šæƒ³â€œå¦‚ä½•åœ¨å¦ä¸€ä¸ªé¡¹ç›®ä¸­ä½¿ç”¨æˆ‘çš„ npm åŒ…è¿›è¡Œæµ‹è¯•ï¼Ÿâ€è®©æˆ‘ä»¬çœ‹çœ‹æ¥ä¸‹æ¥å¦‚ä½•å®ç°è¿™ä¸€ç›®æ ‡ã€‚

#### npmåŒ…æµ‹è¯•

é€šè¿‡å•å…ƒæµ‹è¯•å¯¹ä½ çš„ npm åŒ…çš„ä»£ç æœ‰ä¿¡å¿ƒæ˜¯ä¸€å›äº‹ï¼Œä½†ç¡®ä¿æ•´ä¸ª npm åŒ…çš„ä½¿ç”¨ä½“éªŒæ˜¯å¦ä¸€å›äº‹ã€‚è¿™æ¶‰åŠå°†ä½ çš„ npm åŒ…ä½œä¸ºä¾èµ–é¡¹æ‹‰å…¥å¦ä¸€ä¸ªé¡¹ç›®ï¼Œå¹¶æŸ¥çœ‹å®ƒçš„ä½¿ç”¨æ˜¯å¦åƒä½ æœŸæœ›çš„é‚£æ ·é¡ºåˆ©ã€‚ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹4ç§æ–¹æ³•è¿›è¡Œæµ‹è¯•ï¼š

1. é€šè¿‡ `npm pack` è¾“å‡ºå®‰è£…
2. é€šè¿‡ç›¸å¯¹è·¯å¾„å®‰è£…
3. é€šè¿‡ `npm link`å®‰è£…
4. é€šè¿‡æ³¨å†Œè¡¨å®‰è£…ï¼ˆä¾‹å¦‚ [npmjs.com](https://www.npmjs.com/) ä¸Šçš„ npm å…¬å…±æ³¨å†Œè¡¨ï¼‰

##### npm pack

è¿™ç§æ–¹æ³•å°†åˆ©ç”¨`npm pack`å‘½ä»¤å°†ä½ çš„npmåŒ…æ‰“åŒ…å¹¶å‹ç¼©æˆä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶`<package-name>.tgz`ã€‚ç„¶åï¼Œä½ å¯ä»¥è½¬åˆ°è¦åœ¨å…¶ä¸­ä½¿ç”¨è¯¥è½¯ä»¶åŒ…çš„é¡¹ç›®ï¼Œå¹¶é€šè¿‡æ­¤æ–‡ä»¶è¿›è¡Œå®‰è£…ã€‚æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

1. ä»ä½ çš„npmåŒ…ç›®å½•ä¸­ï¼Œåœ¨ç»ˆç«¯ä¸­è¿è¡Œ`npm pack`ã€‚æ³¨æ„ç”Ÿæˆçš„.tgzæ–‡ä»¶åŠå…¶ä½ç½®ã€‚

2. åˆ‡æ¢åˆ°è¦ä½¿ç”¨npmè½¯ä»¶åŒ…çš„é¡¹ç›®ç›®å½•ã€‚ç¤ºä¾‹ï¼š`cd /path/to/project`

3. åœ¨å®¢æˆ·ç«¯é¡¹ç›®ç›®å½•ä¸­ï¼Œè¿è¡Œ`npm install /path/to/package.tgzï¼Œä½†è¯·å°†å…¶æ›¿æ¢ä¸ºç¬¬1æ­¥ç”Ÿæˆçš„.tgzæ–‡ä»¶æ‰€åœ¨ä½ç½®çš„æ­£ç¡®è·¯å¾„ã€‚

4. ç„¶åï¼Œä½ å¯ä»¥å¼€å§‹åœ¨è¯¥å®¢æˆ·ç«¯é¡¹ç›®ä¸­ä½¿ç”¨è¯¥è½¯ä»¶åŒ…æ¥æµ‹è¯•åŠŸèƒ½ã€‚

è¿™æ ·åšå°†ä½¿ä½ å°½å¯èƒ½æ¥è¿‘å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨è‡ªå·±çš„npmè½¯ä»¶åŒ…ã€‚

##### npm link

è¿™ç§æ–¹æ³•å°†åˆ©ç”¨`npm link`å‘½ä»¤ï¼Œåœ¨å°è¯•åœ¨å®¢æˆ·ç«¯é¡¹ç›®ä¸­å®‰è£…æ—¶æŒ‡å‘ä½ çš„è½¯ä»¶åŒ…ç›®å½•ã€‚æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

1. ä»ä½ çš„npmåŒ…ç›®å½•ä¸­ï¼Œåœ¨ç»ˆç«¯ä¸­è¿è¡Œ `npm link`ã€‚

2. åˆ‡æ¢åˆ°è¦ä½¿ç”¨è¯¥npmè½¯ä»¶åŒ…çš„é¡¹ç›®ç›®å½•ã€‚ ç¤ºä¾‹ï¼š`cd /path/to/project`

3. ä»å®¢æˆ·ç«¯é¡¹ç›®ç›®å½•ä¸­è¿è¡Œ`npm link <name-of-your-package>`ã€‚

å½“å¼•ç”¨ä»£ç æ—¶ï¼Œè¿™ä¼šå°†å®¢æˆ·ç«¯é¡¹ç›®æŒ‡å‘npmè½¯ä»¶åŒ…ç›®å½•ã€‚è¿™ä¸ä¼šç»™ä½ å®Œå…¨åƒç”Ÿäº§ä¸€æ ·ä½¿ç”¨ä½ çš„è½¯ä»¶åŒ…çš„ä½“éªŒï¼Œä½†å¯ä»¥ç¡®ä¿åŠŸèƒ½æŒ‰é¢„æœŸå·¥ä½œã€‚

##### ç›¸å¯¹è·¯å¾„

è¿™ç§æ–¹æ³•åˆ©ç”¨ä½ å·²ç»æŒæ¡çš„ä½¿ç”¨`npm install`å‘½ä»¤çš„çŸ¥è¯†ã€‚å®ƒç±»ä¼¼äº`npm link`ï¼Œè€Œæ— éœ€äº†è§£åƒ`link`è¿™æ ·çš„æ–°å‘½ä»¤ã€‚

1. ä»å®¢æˆ·ç«¯é¡¹ç›®ç›®å½•ä¸­ï¼Œåœ¨ç»ˆç«¯ä¸­è¿è¡Œ `npm install /path/to/your/package`ã€‚

ä¸`npm link`æ–¹æ³•ç±»ä¼¼ï¼Œè¿™å°†å…è®¸ä½ åœ¨å®¢æˆ·ç«¯é¡¹ç›®ä¸­å¿«é€Ÿæµ‹è¯•è½¯ä»¶åŒ…çš„åŠŸèƒ½ï¼Œä½†ä¸ä¼šç»™ä½ å®Œå…¨åƒç”Ÿäº§ä¸€æ ·ä½¿ç”¨ä½ çš„è½¯ä»¶åŒ…çš„ä½“éªŒã€‚è¿™æ˜¯å› ä¸ºå®ƒæŒ‡å‘å®Œæ•´çš„è½¯ä»¶åŒ…æºä»£ç ç›®å½•ï¼Œè€Œä¸æ˜¯ä½ åœ¨npmæ³¨å†Œè¡¨ä¸­æ‰¾åˆ°çš„æ„å»ºç‰ˆæœ¬ã€‚

##### npmæ³¨å†Œè¡¨

æ­¤æ–¹æ³•åˆ©ç”¨å…¬å…±ï¼ˆæˆ–è‡ªå·±ï¼‰NPMè½¯ä»¶åŒ…æ³¨å†Œè¡¨ã€‚å®ƒæ¶‰åŠå‘å¸ƒè½¯ä»¶åŒ…å¹¶åƒä»»ä½•å…¶ä»–NPMè½¯ä»¶åŒ…ä¸€æ ·è¿›è¡Œå®‰è£…ã€‚

1. ä½¿ç”¨æœ¬æ–‡å‰é¢æ¦‚è¿°çš„æ­¥éª¤é€šè¿‡ `npm publish` å‘½ä»¤å‘å¸ƒä½ çš„NPMè½¯ä»¶åŒ…

2. åˆ‡æ¢åˆ°è¦ä½¿ç”¨è¯¥npmè½¯ä»¶åŒ…çš„é¡¹ç›®ç›®å½•ã€‚ç¤ºä¾‹ï¼š`cd /path/to/project`

3. ä»å®¢æˆ·ç«¯é¡¹ç›®ç›®å½•ä¸­è¿è¡Œ `npm install <name-of-your-package>`ã€‚

æ„Ÿè°¢Mirco Kraenz [@MKraenz](https://twitter.com/MKraenz)åˆ›å»ºäº†ä¸€ä¸ª[Twitterçº¿ç¨‹](https://twitter.com/MKraenz/status/1559188177696436226?s=20&t=LJg1FbyDLTmiOGAUQh7LmQ)æ¥æ€»ç»“æˆ‘ä»¬åœ¨ç›´æ’­è¿‡ç¨‹ä¸­å­¦åˆ°çš„ä¸œè¥¿ï¼

ç°åœ¨ï¼Œä½ å·²ç»æ„å»ºäº†æ”¯æŒç°ä»£æ¨¡å—æ ¼å¼çš„è½¯ä»¶åŒ…ï¼Œå¹¶é€šè¿‡å•å…ƒæµ‹è¯•å’Œæ‰“åŒ…æµ‹è¯•ç¡®ä¿å…¶æ­£å¸¸è¿è¡Œã€‚æ¥ä¸‹æ¥ï¼Œä½ éœ€è¦ç¡®ä¿æ²¡æœ‰å®‰å…¨é—®é¢˜ï¼Œå¹¶é˜²æ­¢åœ¨ä½ çš„NPMè½¯ä»¶åŒ…ä¸­å¼•å…¥æ–°é—®é¢˜ã€‚

### å®æ–½å®‰å…¨æ£€æŸ¥

è·³è¿‡è¿™éƒ¨åˆ†çš„ç¿»è¯‘äº†ï¼Œå¦‚æœæœ‰å…´è¶£ï¼Œå¯ä»¥è·³åˆ°åŸæ–‡äº†è§£ã€‚

### è‡ªåŠ¨åŒ–ç‰ˆæœ¬ç®¡ç†å’Œå‘å¸ƒ

æ¯å½“ä½ åˆå¹¶ä¸»åˆ†æ”¯ä¸­çš„æ›´æ”¹æ—¶ï¼Œä½ ä¸å¸Œæœ›æ‰‹åŠ¨æ›´æ–°npmåŒ…çš„ç‰ˆæœ¬å¹¶æ¯æ¬¡éƒ½å‘å¸ƒå®ƒã€‚ç›¸åï¼Œä½ å¸Œæœ›è‡ªåŠ¨åŒ–æ­¤è¿‡ç¨‹ã€‚å¦‚æœä½ è¿˜è®°å¾—æœ¬æ–‡æ—©äº›æ—¶å€™ç®€å•çš„npmåŒ…ç¤ºä¾‹ä¸­ä½¿ç”¨äº†ä»¥ä¸‹å‘½ä»¤æ¥æ›´æ–°npmåŒ…çš„ç‰ˆæœ¬ç„¶åå‘å¸ƒå®ƒï¼š

```bash
npm version <major|minor|patch>
npm publish
```

ä½ è¿˜å¸Œæœ›éµå¾ªè¡Œä¸šæ ‡å‡†è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶ï¼Œä»¥ä¾¿åŒ…çš„æ¶ˆè´¹è€…ç†è§£ä¸åŒç‰ˆæœ¬å˜åŒ–å¯¹æ³¨å†Œè¡¨æ‰€äº§ç”Ÿçš„å½±å“ã€‚

#### ä»€ä¹ˆæ˜¯è¯­ä¹‰ç‰ˆæœ¬æ§åˆ¶ï¼Ÿ

è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶è§„å®šç‰ˆæœ¬å·ç”±ä¸‰ä¸ªå ä½ç¬¦ç»„æˆã€‚ç¬¬ä¸€ä¸ªæ˜¯ä¸»è¦ç‰ˆæœ¬ï¼Œç¬¬äºŒä¸ªæ˜¯æ¬¡è¦ç‰ˆæœ¬ï¼Œæœ€åä¸€ä¸ªæ˜¯è¡¥ä¸ç‰ˆæœ¬ã€‚è¦äº†è§£æ›´å¤šå…³äºè¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶ã€ç‰ˆæœ¬ç®¡ç†å’Œé”æ–‡ä»¶çš„ä¿¡æ¯ï¼Œè¯·é˜…è¯»[ã€Šä»€ä¹ˆæ˜¯ Package Lock JSON ä»¥åŠ Yarn å’Œ NPM åŒ…å¦‚ä½•ä½¿ç”¨é”æ–‡ä»¶ã€‹](https://snyk.io/blog/what-is-package-lock-json/)ã€‚

å¦‚æœä½ èƒ½å¤Ÿè·³è¿‡æ‰‹åŠ¨æ“ä½œï¼Œå¹¶é€šè¿‡ GitHub Actions è®¾ç½®è‡ªåŠ¨åŒ–å·¥ä½œæµæ¥å¤„ç† npm åŒ…å‘å¸ƒï¼Œé‚£å°±å¤ªå¹¸è¿äº†ï¼å› ä¸ºæœ‰ä¸€æ¬¾åä¸º Semantic Release çš„å·¥å…·å¯ä»¥ä¸ GitHub Actions é›†æˆã€‚å¸®åŠ©è‡ªåŠ¨åŒ–è¿™ä¸ªè¿‡ç¨‹çš„å…³é”®åœ¨äºï¼Œåœ¨æäº¤é¡¹ç›®å˜æ›´æ—¶ä½¿ç”¨æ‰€è°“çš„[conventional commits](https://www.conventionalcommits.org/en/v1.0.0/)æ–¹å¼ã€‚è¿™æ ·å¯ä»¥ä½¿è‡ªåŠ¨åŒ–å·¥å…·ç›¸åº”åœ°æ›´æ–°æ‰€æœ‰å†…å®¹ï¼Œå¹¶çŸ¥é“å¦‚ä½•å‡†å¤‡ä¸‹ä¸€ä¸ªé¡¹ç›®å‘å¸ƒã€‚

ä»¥ä¸‹æ­¥éª¤å°†æŒ‡å¯¼ä½ ä¸ºç°ä»£ npm åŒ…è¿›è¡Œè®¾ç½®ã€‚

1. åœ¨ç»ˆç«¯ä¸­è¿è¡Œï¼š`npm i -D semantic-release`
2. åœ¨ç»ˆç«¯ä¸­è¿è¡Œï¼š`npx semantic-release-cli setup`
3. æŒ‰ç…§ç»ˆç«¯æç¤ºæä¾›æ‰€éœ€çš„ä»¤ç‰Œï¼šä½ éœ€è¦ä» GitHub è·å–ä¸€ä¸ªä¸ªäººè®¿é—®ä»¤ç‰Œã€‚

- è¯·å‰å¾€ `https://github.com/<your-name-or-github-organization>/<your-repo-name>/settings/secrets/actions/new` åˆ›å»ºä¸€ä¸ªè®¿é—®ä»¤ç‰Œï¼Œä½†è¯·ç”¨ä½ ç›¸åº”çš„å­˜å‚¨åº“è¯¦ç»†ä¿¡æ¯æ›¿æ¢å®ƒã€‚
- åœ¨åˆ›å»ºæ­¤ä»¤ç‰Œæ—¶ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹èŒƒå›´ï¼š

![personal access token](https://snyk.io/_next/image/?url=https%3A%2F%2Fres.cloudinary.com%2Fsnyk%2Fimage%2Fupload%2Fv1663712555%2Fwordpress-sync%2Fblog-create-npm-packages-new-token.png&w=2560&q=75)

4. ä½ è¿˜éœ€è¦ä¸€ä¸ªæ¥è‡ªnpmçš„Automation-typeè®¿é—®ä»¤ç‰Œï¼Œè¯¥ä»¤ç‰Œå°†ä»…åœ¨CIç¯å¢ƒä¸­ä½¿ç”¨ï¼Œä»¥ä¾¿èƒ½å¤Ÿç»•è¿‡ä½ è´¦æˆ·çš„åŒé‡èº«ä»½éªŒè¯ã€‚è¦åˆ›å»ºä¸€ä¸ªï¼Œè¯·è®¿é—®`https://www.npmjs.com/settings/<your-npm-account>/tokens`ã€‚è¯·åŠ¡å¿…é€‰æ‹©â€œAutomationâ€ç±»å‹ï¼Œå› ä¸ºè¿™å°†ç”¨äºCI/CDå·¥ä½œæµç¨‹ä¸­ã€‚

![new access token](https://snyk.io/_next/image/?url=https%3A%2F%2Fres.cloudinary.com%2Fsnyk%2Fimage%2Fupload%2Fv1663712548%2Fwordpress-sync%2Fblog-create-npm-packages-token.png&w=2560&q=75)

```bash
bc@mbp-snyk modern-npm-package % npx semantic-release-cli setup
? What is your npm registry? https://registry.npmjs.org/
? What is vour nom username? clarkio
? What is your pm password? [hidden]
? What is your NPM two-factor authentication code? <2FA code>
Provide a GitHub Personal Access Token (create a token at https://github.com/settings/tokens/new?scopes=repo
<token>
? What CI are you using? Github Actions
bc@mbp-snyk modern-npm-package %
```

5. å°†ä½ çš„npmä»¤ç‰Œæ·»åŠ åˆ°GitHubå­˜å‚¨åº“ä¸­ï¼Œä½œä¸ºä¸€ä¸ªå­˜å‚¨åº“ç§˜å¯†ã€‚é“¾æ¥ï¼š`https://github.com/<your-name-or-organization//settings/secrets/actions/new`ã€‚å°†ç§˜é’¥çš„åç§°è®¾ç½®ä¸º`NPM_TOKEN`ï¼Œå¹¶ä½¿ç”¨åœ¨ä¹‹å‰æ­¥éª¤ä¸­è·å–çš„å€¼ã€‚

![NPM_TOKEN](https://snyk.io/_next/image/?url=https%3A%2F%2Fres.cloudinary.com%2Fsnyk%2Fimage%2Fupload%2Fv1663712560%2Fwordpress-sync%2Fblog-create-npm-packages-secret.png&w=2560&q=75)

6. å›åˆ°ä½ çš„é¡¹ç›®ä¸­ï¼Œæ‰“å¼€ `package.json` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä¸€ä¸ªå¦‚ä¸‹æ‰€ç¤ºçš„ `releases` é”®ã€‚å¦‚æœä½ çš„ä»“åº“ä¸»åˆ†æ”¯ä»ç„¶å«åš `master` è€Œä¸æ˜¯ `main`ï¼Œè¯·ç›¸åº”åœ°æ›´æ–°ä¸Šè¿° `branches` çš„å€¼ã€‚

```json
"release": {
    "branches": ["main"]
  }
```

7. åŒæ ·åœ¨ `package.json` æ–‡ä»¶ä¸­æ·»åŠ ä¸€ä¸ª `publishConfig` é”®ï¼š

```json
"publishConfig": {
    "access": "public"
 }
```

8. é€šè¿‡ä½¿ç”¨ `semantic-release` npm è„šæœ¬è¿›è¡Œå¹²è¿è¡Œæ¥æµ‹è¯•ä¸€åˆ‡æ˜¯å¦æ­£å¸¸ã€‚å°†ä»¥ä¸‹å‘½ä»¤ä¸­çš„ `NPM_TOKEN=` å’Œ `GH_TOKEN=` å€¼è®¾ç½®ä¸ºä½ å„è‡ªçš„ token å€¼ã€‚ç„¶åå°†å®Œæ•´å‘½ä»¤å¤åˆ¶å¹¶åœ¨ç»ˆç«¯ä¸­è¿è¡Œï¼Œä»¥æŸ¥çœ‹æ˜¯å¦ä¸€åˆ‡éƒ½æ­£ç¡®è¿è¡Œã€‚è¿›ç¨‹æ—¥å¿—å°†æ˜¾ç¤ºåœ¨ç»ˆç«¯è¾“å‡ºä¸­ã€‚å¦‚æœå‡ºç°ä»»ä½•é—®é¢˜ï¼Œå®ƒä»¬å°†åœ¨æ­¤å¤„å¯è§ï¼Œå¹¶æä¾›è§£å†³æ–¹æ³•çš„è¯¦ç»†ä¿¡æ¯ã€‚

9. ç¡®è®¤å¹²è¿è¡ŒæˆåŠŸå®Œæˆåï¼Œå¯ä»¥ä¸º GitHub ä»“åº“è®¾ç½®æ–°çš„ GitHub Action æ¥å¤„ç†å‘å¸ƒè¿‡ç¨‹ã€‚è½¬åˆ° GitHub ä¸Šçš„å­˜å‚¨åº“ï¼Œå¹¶ç‚¹å‡»â€œActionsâ€ã€‚

10. ç‚¹å‡»**New workflow**é€‰é¡¹ã€‚

11. å°†å·¥ä½œæµé‡å‘½åä¸º `release.yml`ã€‚

12. åœ¨æ–°å·¥ä½œæµæ–‡ä»¶ä¸­æ·»åŠ ä»¥ä¸‹ YAML è„šæœ¬ã€‚è¯¥è„šæœ¬åŸºæœ¬ä¸Šè¡¨ç¤ºä¸€æ—¦ Snyk å®‰å…¨æ£€æŸ¥å·¥ä½œæˆåŠŸå®Œæˆï¼Œåˆ™æ‰§è¡Œå‘å¸ƒä»»åŠ¡ï¼ˆrelease jobï¼‰ã€‚å‘å¸ƒä»»åŠ¡ä¼šæ£€å‡ºä»£ç ã€è®¾ç½® Node.js ç¯å¢ƒã€å®‰è£…ä¾èµ–é¡¹ï¼Œç„¶åä½¿ç”¨ä½ çš„ GitHub å’Œ npm ä»¤ç‰Œè¿è¡Œ semantic releaseã€‚

```yaml
name: Release
on:
  workflow_run:
    workflows: ['Snyk Security Check', 'Tests']
    branches: [main]
    types:
      - completed

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: 'lts/*'
      - name: Install dependencies
        run: npm ci
      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN:${{ secrets.NPM_TOKEN }}
        run:npx semantic-release
```

13. æäº¤ä½ çš„æœ¬åœ°æ›´æ”¹å¹¶å°†å…¶æ¨é€åˆ°ä½ çš„GitHubå­˜å‚¨åº“

å¯ä»¥é€šè¿‡åœ¨ç»ˆç«¯ä¸­è¿è¡Œå‘½ä»¤ `git commit -am '<your commit message>'`ï¼Œç„¶å `git push` æ¥å®Œæˆæ­¤æ“ä½œã€‚

ä¹Ÿå¯ä»¥ä½¿ç”¨ VS Code çš„[ç‰ˆæœ¬æ§åˆ¶åŠŸèƒ½](https://code.visualstudio.com/docs/sourcecontrol/overview)æ¥å®Œæˆè¿™ä¸ªæ­¥éª¤ã€‚

14. è®¾ç½®å¥½æ‰€æœ‰å†…å®¹åï¼Œç°åœ¨ä½ å¯ä»¥ä½¿ç”¨[conventional commits](https://www.conventionalcommits.org/zh-hans/v1.0.0/)å°†æ›´æ”¹æ¨é€åˆ°ä¸»åˆ†æ”¯ï¼ˆæˆ–é€šè¿‡åˆå¹¶æ‹‰å–è¯·æ±‚ï¼‰ï¼Œç„¶åå‘å¸ƒå·¥ä½œæµç¨‹å°†è¿è¡Œï¼ˆå½“ç„¶è¦å…ˆè¿›è¡Œ Snyk å®‰å…¨æ£€æŸ¥ï¼‰ã€‚ä½ å¯ä»¥åœ¨ç¤ºä¾‹ [modern-npm-package å­˜å‚¨åº“å·¥ä½œæµç¨‹](https://github.com/clarkio/modern-npm-package/actions/runs/2886059078)ä¸­æŸ¥çœ‹ä¸€ä¸ªå®ä¾‹ã€‚

## é€šè¿‡GitHubä½¿ç”¨Snykè¿›è¡ŒæŒç»­å®‰å…¨ç›‘æ§

è·³è¿‡è¿™éƒ¨åˆ†çš„ç¿»è¯‘äº†ï¼Œå¦‚æœæœ‰å…´è¶£ï¼Œå¯ä»¥è·³åˆ°åŸæ–‡äº†è§£ã€‚

## å¼€å§‹åˆ›å»ºç°ä»£çš„NPMåŒ…

è®©æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ä½ åœ¨æœ¬æ–‡ä¸­å­¦åˆ°çš„æ‰€æœ‰å†…å®¹ã€‚é¦–å…ˆï¼Œä½ äº†è§£äº†å¦‚ä½•è®¾ç½®ã€åˆ›å»ºå’Œéƒ¨ç½²ä¸€ä¸ªç®€å•çš„npmåŒ…ã€‚è¿™å¯¹äºç¬¬ä¸€æ¬¡å‘å¸ƒè‡ªå·±çš„npmåŒ…æ¥è¯´æ˜¯å¾ˆå¥½çš„ï¼Œå¯ä»¥è®©ä½ ç†Ÿæ‚‰æ‰€éœ€æ­¥éª¤ã€‚ç„¶è€Œï¼Œå¦‚æœä½ å¸Œæœ›åˆ¶ä½œä¸€ä¸ªç”¨äºç”Ÿäº§ç¯å¢ƒçš„npmåŒ…ï¼ŒæŒ‰ç…§è¿™ç§æ–¹å¼è¿›è¡Œæ“ä½œä¼šç›¸å½“è´¹æ—¶ä¸”ä¸å¯æŒç»­ã€‚

ä¸ºäº†å®ç°åˆ¶ä½œä¸€ä¸ªé€‚åˆç”Ÿäº§ç¯å¢ƒä½¿ç”¨çš„è½¯ä»¶åŒ…ï¼Œæ¥ä¸‹æ¥ä½ å­¦ä¹ äº†å¦‚ä½•æ„å»ºé€šç”¨æ¨¡å—ï¼ˆCommonJSï¼‰å’ŒECMAScriptæ¨¡å—ï¼ˆESMï¼‰ï¼Œè®¾ç½®å¹¶ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œå®æ–½å®‰å…¨æ£€æŸ¥ä»¥åŠè‡ªåŠ¨åŒ–ç‰ˆæœ¬ç®¡ç†å’Œå‘å¸ƒã€‚æœ‰äº†è¿™äº›çŸ¥è¯†ï¼Œç°åœ¨ä½ å·²ç»å‡†å¤‡å¥½åˆ¶ä½œæ›´å¤šæ˜“äºè¢«ç¤¾åŒºæˆ–å…¬å¸ä½¿ç”¨çš„npmåŒ…äº†ã€‚
